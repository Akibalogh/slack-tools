{% extends "base.html" %}

{% block title %}Audit #{{ audit.id }} - Customer Group Admin{% endblock %}

{% block content %}
<div style="margin-bottom: 20px;">
    <a href="/audits" style="text-decoration: none; color: #0066cc;">‚Üê Back to Audits</a>
</div>

<h2 style="margin-bottom: 20px;">Audit #{{ audit.id }} Details</h2>

<div class="card">
    <h3 style="margin-bottom: 15px;">Audit Information</h3>
    <table>
        <tr>
            <td style="width: 200px;"><strong>Type:</strong></td>
            <td>
                {% if audit.run_type == 'manual' %}
                    üë§ Manual
                {% else %}
                    ‚è∞ Scheduled
                {% endif %}
            </td>
        </tr>
        <tr>
            <td><strong>Status:</strong></td>
            <td>
                <span class="badge badge-{{ audit.status }}">
                    {% if audit.status == 'running' %}‚è≥{% elif audit.status == 'completed' %}‚úÖ{% else %}‚ùå{% endif %}
                    {{ audit.status }}
                </span>
            </td>
        </tr>
        <tr>
            <td><strong>Started:</strong></td>
            <td>{{ audit.started_at }}</td>
        </tr>
        <tr>
            <td><strong>Completed:</strong></td>
            <td>{{ audit.completed_at or 'Still running...' }}</td>
        </tr>
        {% if audit.slack_channels_total %}
        <tr>
            <td><strong>Slack Channels:</strong></td>
            <td>
                {{ audit.slack_channels_complete or 0 }}/{{ audit.slack_channels_total }}
                ({{ ((audit.slack_channels_complete or 0) * 100 / audit.slack_channels_total) | round(1) }}% complete)
            </td>
        </tr>
        {% endif %}
        {% if audit.telegram_groups_total %}
        <tr>
            <td><strong>Telegram Groups:</strong></td>
            <td>
                {{ audit.telegram_groups_complete or 0 }}/{{ audit.telegram_groups_total }}
                ({{ ((audit.telegram_groups_complete or 0) * 100 / audit.telegram_groups_total) | round(1) }}% complete)
            </td>
        </tr>
        {% endif %}
        {% if audit.error_message %}
        <tr>
            <td><strong>Error:</strong></td>
            <td style="color: #e74c3c;">{{ audit.error_message }}</td>
        </tr>
        {% endif %}
    </table>
</div>

{% if findings %}
<div class="card">
    <h3 style="margin-bottom: 15px;">Findings ({{ findings|length }})</h3>
    
    <table>
        <thead>
            <tr>
                <th>Platform</th>
                <th>Channel/Group</th>
                <th>Missing Members</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for finding in findings %}
            <tr>
                <td>
                    {% if finding.platform == 'slack' %}
                        üí¨ Slack
                    {% else %}
                        ‚úàÔ∏è Telegram
                    {% endif %}
                </td>
                <td>
                    <strong>{{ finding.channel_name }}</strong>
                    {% if finding.channel_id %}
                        <br><small style="color: #666;">{{ finding.channel_id }}</small>
                    {% endif %}
                </td>
                <td>
                    {% set missing = finding.missing_members | replace('"', '') | replace('[', '') | replace(']', '') %}
                    <span style="color: #e74c3c;">{{ missing }}</span>
                </td>
                <td>
                    <span class="badge {% if finding.status == 'incomplete' %}badge-warning{% else %}badge-failed{% endif %}">
                        {{ finding.status }}
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="card">
    {% if audit.status == 'running' or audit.status == 'pending' %}
    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #856404;">‚è≥ Audit In Progress</h3>
        <p style="margin: 0; color: #856404;">
            The audit is currently running. Detailed results will appear here once the audit completes.
            {% if audit.status == 'running' %}
            This typically takes 13-18 minutes for a full audit (Slack + Telegram).
            {% endif %}
        </p>
        <p style="margin: 10px 0 0 0; font-size: 14px; color: #856404;">
            <strong>Refresh this page</strong> in a few minutes to see the results.
        </p>
    </div>
    {% else %}
    <h3 style="margin-bottom: 15px;">‚úÖ No Issues Found</h3>
    <p style="color: #666;">All channels have the required team members.</p>
    {% endif %}
</div>
{% endif %}

{% if report_data %}
<div class="card" style="margin-top: 20px;">
    <h3 style="margin-bottom: 15px;">üìä Full Audit Report</h3>
    
    {% set slack_channels = report_data.slack_channels or [] %}
    {% set telegram_groups = report_data.telegram_groups or [] %}
    
    {% if slack_channels %}
    <h4 style="margin: 20px 0 10px 0;"><i class="fab fa-slack" style="color: #4A154B;"></i> <strong>Slack Channels</strong> ({{ slack_channels|length }})</h4>
    <table style="margin-bottom: 30px;">
        <thead>
            <tr>
                <th>Channel Name</th>
                <th>Missing Members</th>
                <th>Completeness</th>
            </tr>
        </thead>
        <tbody>
            {% for channel in slack_channels %}
            <tr>
                <td><strong>{{ channel['Group Name'] or channel.name }}</strong></td>
                <td>
                    {% if channel.get('Required Missing') and channel['Required Missing'] != '-' %}
                        <span style="color: #e74c3c;">{{ channel['Required Missing'] }}</span>
                    {% else %}
                        <span style="color: #27ae60;">‚úì All Present</span>
                    {% endif %}
                </td>
                <td>
                    <span class="badge {% if channel.get('Required Missing') and channel['Required Missing'] != '-' %}badge-warning{% else %}badge-completed{% endif %}">
                        {{ channel.get('Completeness', '100%') }}
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
    
    {% if telegram_groups %}
    <h4 style="margin: 20px 0 10px 0;"><i class="fab fa-telegram" style="color: #0088CC;"></i> <strong>Telegram Groups</strong> (<span id="group-count">{{ telegram_groups|length }}</span> shown)</h4>
    
    <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 15px; display: flex; gap: 15px; flex-wrap: wrap;">
        <div>
            <label style="font-weight: bold; margin-right: 5px;">Category:</label>
            <select id="filter-category" onchange="filterTable()" style="padding: 5px;">
                <option value="">All</option>
                <option value="Customer">Customer</option>
                <option value="Marketing">Marketing</option>
                <option value="Internal">Internal</option>
                <option value="Intro">Intro</option>
            </select>
        </div>
        <div>
            <label style="font-weight: bold; margin-right: 5px;">BitSafe Name:</label>
            <select id="filter-bitsafe" onchange="filterTable()" style="padding: 5px;">
                <option value="">All</option>
                <option value="YES">‚úì YES (Active)</option>
                <option value="No">No (Old/Retired)</option>
            </select>
        </div>
        <div>
            <label style="font-weight: bold; margin-right: 5px;">Admin Status:</label>
            <select id="filter-admin" onchange="filterTable()" style="padding: 5px;">
                <option value="">All</option>
                <option value="Owner">Owner</option>
                <option value="Admin">Admin</option>
                <option value="Member">Member (‚ö†Ô∏è)</option>
            </select>
        </div>
        <div>
            <label style="font-weight: bold; margin-right: 5px;">History:</label>
            <select id="filter-history" onchange="filterTable()" style="padding: 5px;">
                <option value="">All</option>
                <option value="Visible">Visible</option>
                <option value="HIDDEN">Hidden (‚ö†Ô∏è)</option>
            </select>
        </div>
        <div>
            <label style="font-weight: bold; margin-right: 5px;">Missing Members:</label>
            <select id="filter-missing" onchange="filterTable()" style="padding: 5px;">
                <option value="">All</option>
                <option value="none">All Present</option>
                <option value="has-missing">Has Missing</option>
            </select>
        </div>
        <button onclick="clearFilters()" style="padding: 5px 15px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Clear Filters</button>
    </div>
    
    <table id="telegram-table">
        <thead>
            <tr>
                <th>Group Name</th>
                <th>Category</th>
                <th>BitSafe Name</th>
                <th>Admin Status</th>
                <th>History</th>
                <th>Missing Members</th>
                <th>Completeness</th>
            </tr>
        </thead>
        <tbody>
            {% for group in telegram_groups %}
            <tr{% if group.get('Has BitSafe Name') != '‚úì YES' %} style="opacity: 0.6;"{% endif %}>
                <td><strong>{{ group['Group Name'] or group.name }}</strong></td>
                <td>
                    <span style="font-size: 12px; {% if group.get('Category') == 'BD Customer' %}font-weight: bold; color: #2980b9;{% endif %}">
                        {{ group.get('Category', '-') }}
                    </span>
                </td>
                <td>
                    <span style="{% if group.get('Has BitSafe Name') == '‚úì YES' %}color: #27ae60; font-weight: bold;{% else %}color: #95a5a6;{% endif %}">
                        {{ group.get('Has BitSafe Name', 'No') }}
                    </span>
                </td>
                <td>
                    <span style="{% if group.get('Admin Status') == 'Member' %}color: #e74c3c; font-weight: bold;{% elif group.get('Admin Status') == 'Owner' %}color: #27ae60;{% endif %}">
                        {{ group.get('Admin Status', '-') }}
                    </span>
                </td>
                <td>
                    <span style="{% if 'HIDDEN' in (group.get('History Visibility') or '') %}color: #e74c3c; font-weight: bold;{% endif %}">
                        {{ group.get('History Visibility', '-') }}
                    </span>
                </td>
                <td>
                    {% if group.get('Required Missing') and group['Required Missing'] != '-' %}
                        <span style="color: #e74c3c;">{{ group['Required Missing'] }}</span>
                    {% else %}
                        <span style="color: #27ae60;">‚úì All Present</span>
                    {% endif %}
                </td>
                <td>
                    <span class="badge {% if group.get('Required Missing') and group['Required Missing'] != '-' %}badge-warning{% else %}badge-completed{% endif %}">
                        {{ group.get('Completeness', '100%') }}
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
function filterTable() {
    const table = document.getElementById('telegram-table');
    if (!table) return;
    
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    const categoryFilter = document.getElementById('filter-category').value.toLowerCase();
    const bitsafeFilter = document.getElementById('filter-bitsafe').value;
    const adminFilter = document.getElementById('filter-admin').value.toLowerCase();
    const historyFilter = document.getElementById('filter-history').value.toLowerCase();
    const missingFilter = document.getElementById('filter-missing').value;
    
    let visibleCount = 0;
    
    for (let row of rows) {
        const cells = row.getElementsByTagName('td');
        if (cells.length < 7) continue;
        
        const category = cells[1].textContent.trim().toLowerCase();
        const bitsafeName = cells[2].textContent.trim();
        const adminStatus = cells[3].textContent.trim().toLowerCase();
        const history = cells[4].textContent.trim().toLowerCase();
        const missing = cells[5].textContent.trim();
        
        let show = true;
        
        if (categoryFilter && !category.includes(categoryFilter)) show = false;
        if (bitsafeFilter && !bitsafeName.includes(bitsafeFilter)) show = false;
        if (adminFilter && !adminStatus.includes(adminFilter)) show = false;
        if (historyFilter && !history.includes(historyFilter)) show = false;
        if (missingFilter === 'none' && !missing.includes('All Present')) show = false;
        if (missingFilter === 'has-missing' && missing.includes('All Present')) show = false;
        
        row.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    }
    
    document.getElementById('group-count').textContent = visibleCount;
}

function clearFilters() {
    document.getElementById('filter-category').value = '';
    document.getElementById('filter-bitsafe').value = '';
    document.getElementById('filter-admin').value = '';
    document.getElementById('filter-history').value = '';
    document.getElementById('filter-missing').value = '';
    filterTable();
}
</script>
{% endblock %}


