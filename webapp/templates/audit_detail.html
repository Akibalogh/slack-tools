{% extends "base.html" %}

{% block title %}Audit #{{ audit.id }} - Customer Group Admin{% endblock %}

{% block content %}
<div style="margin-bottom: 20px;">
    <a href="/audits" style="text-decoration: none; color: #0066cc;">‚Üê Back to Audits</a>
</div>

<h2 style="margin-bottom: 20px;">Audit #{{ audit.id }} Details</h2>

<div class="card">
    <h3 style="margin-bottom: 15px;">Audit Information</h3>
    <table>
        <tr>
            <td style="width: 200px;"><strong>Type:</strong></td>
            <td>
                {% if audit.run_type == 'manual' %}
                    üë§ Manual
                {% else %}
                    ‚è∞ Scheduled
                {% endif %}
            </td>
        </tr>
        <tr>
            <td><strong>Status:</strong></td>
            <td>
                <span class="badge badge-{{ audit.status }}">
                    {% if audit.status == 'running' %}‚è≥{% elif audit.status == 'completed' %}‚úÖ{% else %}‚ùå{% endif %}
                    {{ audit.status }}
                </span>
            </td>
        </tr>
        <tr>
            <td><strong>Started:</strong></td>
            <td>{{ audit.started_at }}</td>
        </tr>
        <tr>
            <td><strong>Completed:</strong></td>
            <td>{{ audit.completed_at or 'Still running...' }}</td>
        </tr>
        {% if audit.slack_channels_total %}
        <tr>
            <td><strong>Slack Channels:</strong></td>
            <td>
                {{ audit.slack_channels_complete or 0 }}/{{ audit.slack_channels_total }}
                ({{ ((audit.slack_channels_complete or 0) * 100 / audit.slack_channels_total) | round(1) }}% complete)
            </td>
        </tr>
        {% endif %}
        {% if audit.telegram_groups_total %}
        <tr>
            <td><strong>Telegram Groups:</strong></td>
            <td>
                {{ audit.telegram_groups_complete or 0 }}/{{ audit.telegram_groups_total }}
                ({{ ((audit.telegram_groups_complete or 0) * 100 / audit.telegram_groups_total) | round(1) }}% complete)
            </td>
        </tr>
        {% endif %}
        {% if audit.report_path %}
        <tr>
            <td><strong>Report File:</strong></td>
            <td><code>{{ audit.report_path }}</code></td>
        </tr>
        {% endif %}
        {% if audit.error_message %}
        <tr>
            <td><strong>Error:</strong></td>
            <td style="color: #e74c3c;">{{ audit.error_message }}</td>
        </tr>
        {% endif %}
    </table>
</div>

{% if findings %}
<div class="card">
    <h3 style="margin-bottom: 15px;">Findings ({{ findings|length }})</h3>
    
    <table>
        <thead>
            <tr>
                <th>Platform</th>
                <th>Channel/Group</th>
                <th>Missing Members</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for finding in findings %}
            <tr>
                <td>
                    {% if finding.platform == 'slack' %}
                        üí¨ Slack
                    {% else %}
                        ‚úàÔ∏è Telegram
                    {% endif %}
                </td>
                <td>
                    <strong>{{ finding.channel_name }}</strong>
                    {% if finding.channel_id %}
                        <br><small style="color: #666;">{{ finding.channel_id }}</small>
                    {% endif %}
                </td>
                <td>
                    {% set missing = finding.missing_members | replace('"', '') | replace('[', '') | replace(']', '') %}
                    <span style="color: #e74c3c;">{{ missing }}</span>
                </td>
                <td>
                    <span class="badge {% if finding.status == 'incomplete' %}badge-warning{% else %}badge-failed{% endif %}">
                        {{ finding.status }}
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="card">
    <h3 style="margin-bottom: 15px;">‚úÖ No Issues Found</h3>
    <p style="color: #666;">All channels have the required team members.</p>
</div>
{% endif %}

{% if report_data %}
<div class="card" style="margin-top: 20px;">
    <h3 style="margin-bottom: 15px;">üìä Full Audit Report</h3>
    
    {% set slack_channels = report_data.slack_channels or [] %}
    {% set telegram_groups = report_data.telegram_groups or [] %}
    
    {% if slack_channels %}
    <h4 style="margin: 20px 0 10px 0;">üí¨ Slack Channels ({{ slack_channels|length }})</h4>
    <table style="margin-bottom: 30px;">
        <thead>
            <tr>
                <th>Channel Name</th>
                <th>Required Members</th>
                <th>Missing</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for channel in slack_channels[:50] %}
            <tr>
                <td><strong>{{ channel['Group Name'] or channel.name }}</strong></td>
                <td>{{ channel['Required Members'] or '-' }}</td>
                <td>
                    {% if channel['Missing Members'] %}
                        <span style="color: #e74c3c;">{{ channel['Missing Members'] }}</span>
                    {% else %}
                        <span style="color: #27ae60;">‚úì Complete</span>
                    {% endif %}
                </td>
                <td>
                    <span class="badge {% if channel['Missing Members'] %}badge-warning{% else %}badge-completed{% endif %}">
                        {{ channel['Completeness'] or '100%' }}
                    </span>
                </td>
            </tr>
            {% endfor %}
            {% if slack_channels|length > 50 %}
            <tr>
                <td colspan="4" style="text-align: center; color: #666;">
                    ... and {{ slack_channels|length - 50 }} more channels (showing first 50)
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
    {% endif %}
    
    {% if telegram_groups %}
    <h4 style="margin: 20px 0 10px 0;">‚úàÔ∏è Telegram Groups ({{ telegram_groups|length }})</h4>
    <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
        Groups with "‚úì YES" in BitSafe Name are active work groups. Groups with "No" may be old/retired.
    </p>
    <table>
        <thead>
            <tr>
                <th>Group Name</th>
                <th>BitSafe Name</th>
                <th>Required Members</th>
                <th>Missing</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for group in telegram_groups[:50] %}
            <tr{% if group.get('Has BitSafe Name') != '‚úì YES' %} style="opacity: 0.6;"{% endif %}>
                <td><strong>{{ group['Group Name'] or group.name }}</strong></td>
                <td>
                    <span style="{% if group.get('Has BitSafe Name') == '‚úì YES' %}color: #27ae60; font-weight: bold;{% else %}color: #95a5a6;{% endif %}">
                        {{ group.get('Has BitSafe Name', 'No') }}
                    </span>
                </td>
                <td>{{ group['Required Members'] or '-' }}</td>
                <td>
                    {% if group['Missing Members'] %}
                        <span style="color: #e74c3c;">{{ group['Missing Members'] }}</span>
                    {% else %}
                        <span style="color: #27ae60;">‚úì Complete</span>
                    {% endif %}
                </td>
                <td>
                    <span class="badge {% if group['Missing Members'] %}badge-warning{% else %}badge-completed{% endif %}">
                        {{ group['Completeness'] or '100%' }}
                    </span>
                </td>
            </tr>
            {% endfor %}
            {% if telegram_groups|length > 50 %}
            <tr>
                <td colspan="4" style="text-align: center; color: #666;">
                    ... and {{ telegram_groups|length - 50 }} more groups (showing first 50)
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
    {% endif %}
</div>
{% endif %}

{% endblock %}


