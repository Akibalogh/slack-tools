{% extends "base.html" %}

{% block title %}Dashboard - Customer Group Admin{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-card success">
        <div class="stat-value">{{ active_count }}</div>
        <div class="stat-label">Team Members</div>
    </div>
    
    {% if latest_audit %}
    <div class="stat-card {% if latest_audit.status == 'completed' %}success{% elif latest_audit.status == 'failed' %}warning{% else %}info{% endif %}">
        <div class="stat-value">
            {% if latest_audit.status == 'running' %}
                ‚è≥ Running
            {% elif latest_audit.slack_channels_total %}
                {{ latest_audit.slack_channels_complete }}/{{ latest_audit.slack_channels_total }}
            {% elif latest_audit.telegram_groups_total %}
                {{ latest_audit.telegram_groups_complete }}/{{ latest_audit.telegram_groups_total }}
            {% else %}
                --
            {% endif %}
        </div>
        <div class="stat-label">Latest Audit Coverage</div>
    </div>
    {% endif %}
</div>

<div class="card">
    <h2 style="margin-bottom: 20px;">Quick Actions</h2>
    <div style="display: flex; gap: 15px;">
        <a href="/audits" class="btn btn-secondary">üìä View Audit History</a>
        <a href="/employees" class="btn btn-secondary">üë• View Employees</a>
    </div>
    <p style="margin-top: 15px; color: #666; font-size: 14px;">
        ‚ÑπÔ∏è Audits run automatically daily at 2:00 AM UTC via Heroku Scheduler
    </p>
</div>

{% if latest_audit %}
<div class="card">
    <h2 style="margin-bottom: 15px;">Latest Audit</h2>
    <table style="margin-top: 15px;">
        <tr>
            <td><strong>Run Time:</strong></td>
            <td>{{ latest_audit.started_at }}</td>
        </tr>
        <tr>
            <td><strong>Status:</strong></td>
            <td><span class="badge badge-{{ latest_audit.status }}">{{ latest_audit.status }}</span></td>
        </tr>
        <tr>
            <td><i class="fab fa-slack" style="color: #4A154B;"></i> <strong>Slack Channels:</strong></td>
            <td>
                {% if latest_audit.status == 'running' %}
                    {% if latest_audit.slack_channels_total %}
                        {{ latest_audit.slack_channels_complete or 0 }}/{{ latest_audit.slack_channels_total }} complete
                    {% elif latest_audit.slack_progress_current %}
                        ‚è≥ Auditing... {{ latest_audit.slack_progress_current }} scanned
                    {% else %}
                        ‚è≥ Starting Slack audit...
                    {% endif %}
                {% else %}
                    {{ latest_audit.slack_channels_complete or 0 }}/{{ latest_audit.slack_channels_total or 0 }} complete
                {% endif %}
            </td>
        </tr>
        <tr>
            <td><i class="fab fa-telegram" style="color: #0088CC;"></i> <strong>Telegram Groups:</strong></td>
            <td>
                {% if latest_audit.status == 'running' %}
                    {% if latest_audit.telegram_groups_total %}
                        {{ latest_audit.telegram_groups_complete or 0 }}/{{ latest_audit.telegram_groups_total }} complete
                    {% elif latest_audit.telegram_progress_current %}
                        ‚è≥ Auditing... {{ latest_audit.telegram_progress_current }} scanned
                    {% elif latest_audit.slack_progress_current %}
                        ‚è≥ Waiting for Slack to finish...
                    {% else %}
                        ‚è≥ Pending...
                    {% endif %}
                {% elif latest_audit.telegram_groups_total %}
                    {{ latest_audit.telegram_groups_complete or 0 }}/{{ latest_audit.telegram_groups_total or 0 }} complete
                {% else %}
                    -
                {% endif %}
            </td>
        </tr>
    </table>
    <div style="margin-top: 15px;">
        <a href="/audits/{{ latest_audit.id }}" class="btn btn-secondary">View Details</a>
    </div>
</div>
{% else %}
<div class="card">
    <h2 style="margin-bottom: 15px;">No Audits Yet</h2>
    <p style="color: #666; margin-bottom: 15px;">The first audit will run automatically at 2:00 AM UTC via Heroku Scheduler.</p>
</div>
{% endif %}

{% if recent_offboarding %}
<div class="card">
    <h2 style="margin-bottom: 15px;">Recent Offboarding Tasks</h2>
    <table>
        <thead>
            <tr>
                <th>Employee</th>
                <th>Platform</th>
                <th>Status</th>
                <th>Started</th>
                <th>Completed</th>
            </tr>
        </thead>
        <tbody>
            {% for task in recent_offboarding %}
            <tr>
                <td>{{ task.employee_name }}</td>
                <td>{{ task.platform }}</td>
                <td><span class="badge badge-{{ task.status }}">{{ task.status }}</span></td>
                <td>{{ task.started_at or '-' }}</td>
                <td>{{ task.completed_at or '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% endblock %}

