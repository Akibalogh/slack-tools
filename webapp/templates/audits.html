{% extends "base.html" %}

{% block title %}Audits - Customer Group Admin{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
    <div>
        <h2>Audit History</h2>
        <p style="color: #666; margin-top: 10px;">
            üí¨ Slack audits run automatically daily at 2:00 AM UTC<br>
            ‚úàÔ∏è Telegram audits require manual trigger with 2FA authentication
        </p>
    </div>
    <button onclick="startTelegramAudit()" class="btn btn-primary" style="white-space: nowrap;">
        ‚úàÔ∏è Run Telegram Audit
    </button>
</div>

{% if findings %}
<div class="card">
    <h3 style="margin-bottom: 15px;">‚ö†Ô∏è Latest Audit - Incomplete Channels</h3>
    <p style="color: #666; margin-bottom: 15px;">
        These channels are missing required team members.
    </p>
    
    <table>
        <thead>
            <tr>
                <th>Platform</th>
                <th>Channel</th>
                <th>Missing Members</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for finding in findings %}
            <tr>
                <td>
                    {% if finding.platform == 'slack' %}
                        üí¨ Slack
                    {% else %}
                        ‚úàÔ∏è Telegram
                    {% endif %}
                </td>
                <td><strong>{{ finding.channel_name }}</strong></td>
                <td>{{ finding.missing_members }}</td>
                <td><span class="badge badge-warning">{{ finding.status }}</span></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<div class="card">
    <h3 style="margin-bottom: 15px;">‚è∞ Scheduled Slack Audits (Automated Daily at 2:00 AM UTC)</h3>
    <p style="color: #666; margin-bottom: 15px;">
        Automated audits of Slack channels for required team member access. Runs via Heroku Scheduler without user interaction.
    </p>
    
    {% if scheduled_audits %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Status</th>
                <th>Started</th>
                <th>Completed</th>
                <th>Coverage</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for audit in scheduled_audits %}
            <tr>
                <td>{{ audit.id }}</td>
                <td>
                    <span class="badge badge-{{ audit.status }}">
                        {% if audit.status == 'running' %}‚è≥{% elif audit.status == 'completed' %}‚úÖ{% else %}‚ùå{% endif %}
                        {{ audit.status }}
                    </span>
                </td>
                <td>{{ audit.started_at }}</td>
                <td>{{ audit.completed_at or '-' }}</td>
                <td>
                    {% if audit.slack_channels_total %}
                        {{ audit.slack_channels_complete or 0 }}/{{ audit.slack_channels_total }}
                        ({{ ((audit.slack_channels_complete or 0) * 100 / audit.slack_channels_total) | round(1) }}%)
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    <a href="/audits/{{ audit.id }}" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;">
                        View Details
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #666;">No scheduled audits yet. The first audit will run automatically at 2:00 AM UTC via Heroku Scheduler.</p>
    {% endif %}
</div>

<div class="card" style="margin-top: 20px;">
    <h3 style="margin-bottom: 15px;">‚úàÔ∏è Manual Telegram Audits (Requires 2FA)</h3>
    <p style="color: #666; margin-bottom: 15px;">
        On-demand Telegram group audits. Requires manual trigger with 2FA authentication (cannot run automatically due to Telegram security). Click "Run Telegram Audit" button above.
    </p>
    
    {% if manual_audits %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Status</th>
                <th>Started</th>
                <th>Completed</th>
                <th>Telegram Coverage</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for audit in manual_audits %}
            <tr>
                <td>{{ audit.id }}</td>
                <td>
                    <span class="badge badge-{{ audit.status }}">
                        {% if audit.status == 'running' %}‚è≥{% elif audit.status == 'completed' %}‚úÖ{% else %}‚ùå{% endif %}
                        {{ audit.status }}
                    </span>
                </td>
                <td>{{ audit.started_at }}</td>
                <td>{{ audit.completed_at or '-' }}</td>
                <td>
                    {% if audit.telegram_groups_total %}
                        {{ audit.telegram_groups_complete or 0 }}/{{ audit.telegram_groups_total }}
                        ({{ ((audit.telegram_groups_complete or 0) * 100 / audit.telegram_groups_total) | round(1) }}%)
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    <a href="/audits/{{ audit.id }}" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;">
                        View Details
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #666;">No manual Telegram audits yet. Click the "Run Telegram Audit" button above to start one.</p>
    {% endif %}
</div>

<!-- Telegram Audit Modal -->
<div id="telegram-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 500px; margin: 20px;">
        <h3 style="margin-bottom: 15px;">Telegram Audit</h3>
        
        <div id="telegram-status" style="margin-bottom: 20px;">
            <p id="telegram-message">Starting...</p>
        </div>
        
        <div id="telegram-code-input" style="display: none; margin-bottom: 20px;">
            <label for="telegram-code" style="display: block; margin-bottom: 5px; font-weight: bold;">
                Enter 2FA Code:
            </label>
            <input type="text" id="telegram-code" placeholder="12345" 
                   style="width: 100%; padding: 10px; font-size: 16px; border: 1px solid #ddd; border-radius: 4px;" 
                   maxlength="6">
            <p style="color: #666; font-size: 14px; margin-top: 5px;">
                Enter the code sent to your Telegram app
            </p>
        </div>
        
        <div id="telegram-password-input" style="display: none; margin-bottom: 20px;">
            <label for="telegram-password" style="display: block; margin-bottom: 5px; font-weight: bold;">
                Enter 2FA Password:
            </label>
            <input type="password" id="telegram-password" placeholder="Your 2FA password" 
                   style="width: 100%; padding: 10px; font-size: 16px; border: 1px solid #ddd; border-radius: 4px;">
            <p style="color: #666; font-size: 14px; margin-top: 5px;">
                Enter your Telegram 2FA password (cloud password)
            </p>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button id="telegram-submit-code-btn" onclick="submitTelegramCode()" class="btn btn-primary" style="display: none;">
                Submit Code
            </button>
            <button id="telegram-submit-password-btn" onclick="submitTelegramPassword()" class="btn btn-primary" style="display: none;">
                Submit Password
            </button>
            <button onclick="closeTelegramModal()" class="btn btn-secondary" id="telegram-close-btn">
                Close
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let telegramPollInterval = null;

function startTelegramAudit() {
    // Show modal
    document.getElementById('telegram-modal').style.display = 'flex';
    document.getElementById('telegram-message').textContent = 'Starting Telegram audit...';
    document.getElementById('telegram-code-input').style.display = 'none';
    document.getElementById('telegram-password-input').style.display = 'none';
    document.getElementById('telegram-submit-code-btn').style.display = 'none';
    document.getElementById('telegram-submit-password-btn').style.display = 'none';
    
    // Start audit
    fetch('/api/audit/telegram/start', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            document.getElementById('telegram-message').textContent = 'Error: ' + data.error;
            return;
        }
        
        // Start polling for status
        telegramPollInterval = setInterval(pollTelegramStatus, 2000);
    })
    .catch(err => {
        document.getElementById('telegram-message').textContent = 'Error: ' + err;
    });
}

function pollTelegramStatus() {
    fetch('/api/audit/telegram/status')
    .then(res => res.json())
    .then(data => {
        document.getElementById('telegram-message').textContent = data.message || data.status;
        
        if (data.status === 'waiting_for_code') {
            // Show code input
            document.getElementById('telegram-code-input').style.display = 'block';
            document.getElementById('telegram-password-input').style.display = 'none';
            document.getElementById('telegram-submit-code-btn').style.display = 'inline-block';
            document.getElementById('telegram-submit-password-btn').style.display = 'none';
            document.getElementById('telegram-code').focus();
        }
        
        if (data.status === 'waiting_for_password') {
            // Show password input
            document.getElementById('telegram-code-input').style.display = 'none';
            document.getElementById('telegram-password-input').style.display = 'block';
            document.getElementById('telegram-submit-code-btn').style.display = 'none';
            document.getElementById('telegram-submit-password-btn').style.display = 'inline-block';
            document.getElementById('telegram-password').focus();
        }
        
        if (data.status === 'completed') {
            clearInterval(telegramPollInterval);
            document.getElementById('telegram-close-btn').textContent = 'Refresh Page';
            document.getElementById('telegram-close-btn').onclick = () => location.reload();
        }
        
        if (data.status === 'error') {
            clearInterval(telegramPollInterval);
            document.getElementById('telegram-message').textContent = 'Error: ' + (data.error || 'Unknown error');
        }
    })
    .catch(err => {
        clearInterval(telegramPollInterval);
        document.getElementById('telegram-message').textContent = 'Error checking status: ' + err;
    });
}

function submitTelegramCode() {
    const code = document.getElementById('telegram-code').value.trim();
    
    if (!code) {
        alert('Please enter the code');
        return;
    }
    
    document.getElementById('telegram-message').textContent = 'Submitting code...';
    document.getElementById('telegram-code-input').style.display = 'none';
    document.getElementById('telegram-submit-code-btn').style.display = 'none';
    
    fetch('/api/audit/telegram/code', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({code: code})
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            document.getElementById('telegram-message').textContent = 'Error: ' + data.error;
            document.getElementById('telegram-code-input').style.display = 'block';
            document.getElementById('telegram-submit-code-btn').style.display = 'inline-block';
        }
    })
    .catch(err => {
        document.getElementById('telegram-message').textContent = 'Error: ' + err;
    });
}

function submitTelegramPassword() {
    const password = document.getElementById('telegram-password').value.trim();
    
    if (!password) {
        alert('Please enter your 2FA password');
        return;
    }
    
    document.getElementById('telegram-message').textContent = 'Submitting password...';
    document.getElementById('telegram-password-input').style.display = 'none';
    document.getElementById('telegram-submit-password-btn').style.display = 'none';
    
    fetch('/api/audit/telegram/password', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({password: password})
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            document.getElementById('telegram-message').textContent = 'Error: ' + data.error;
            document.getElementById('telegram-password-input').style.display = 'block';
            document.getElementById('telegram-submit-password-btn').style.display = 'inline-block';
        }
    })
    .catch(err => {
        document.getElementById('telegram-message').textContent = 'Error: ' + err;
    });
}

function closeTelegramModal() {
    if (telegramPollInterval) {
        clearInterval(telegramPollInterval);
    }
    document.getElementById('telegram-modal').style.display = 'none';
}

// Allow Enter key to submit code/password
document.addEventListener('DOMContentLoaded', function() {
    const codeInput = document.getElementById('telegram-code');
    if (codeInput) {
        codeInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitTelegramCode();
            }
        });
    }
    
    const passwordInput = document.getElementById('telegram-password');
    if (passwordInput) {
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitTelegramPassword();
            }
        });
    }
});
</script>
{% endblock %}

